name: Publish Release

on:
  workflow_dispatch:
    inputs:
      newVersion:
        description: version override
        type: string
        required: false

jobs:
  publish-releases:
    name: Publish Releases
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      # publishes the last uploaded version on Chrome Web Store servers;
      # see https://github.com/fregante/chrome-webstore-upload-cli#usage
      - name: Chrome â€” Publish Release
        run: npm run chrome-publish
        continue-on-error: true
        env:
          EXTENSION_ID: ${{ secrets.CWS_EXTENSION_ID }}
          CLIENT_ID: ${{ secrets.CWS_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CWS_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.CWS_REFRESH_TOKEN }}

      - name: Update release metadata
        run: node dev/update_release_metadata.mjs ${{ inputs.newVersion || '' }}

      - name: Create release pull request
        uses: peter-evans/create-pull-request@v7
        with:
          title: Update release metadata
          commit-message: update release metadata
          branch: update-release-metadata
          body: |
            Updates the extension version in metadata files, triggering Firefox autoupdate and the "Please update XKit!" in-extension notification.

            Remember to confirm that the referenced version is released on Github, the .xpi file link works, and the Chrome web store has the referenced version available before merging this.
